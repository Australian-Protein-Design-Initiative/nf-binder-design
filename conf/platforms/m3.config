/*
 * This is a configuration specific to users of the M3 / MASSIVE HPC cluster at Monash University.
 */

params.slurm_account = false

def random_choice(choices) {
    return choices[new Random().nextInt(choices.size())]
}

executor {
    $slurm {
        queueSize = 200
        pollInterval = '30 sec'
        queueStatInterval = '10m'
    }
}

process {
    executor = 'slurm'
    stageInMode = 'symlink'
    errorStrategy = 'retry'
    maxRetries = 1
    cache = 'lenient'

    withName: UNIQUE_ID {
        executor = 'local'
    }

    withName: GET_CONTIGS {
        //container = params.containers.get_contigs
        executor = 'local'
    }

    withName: RENUMBER_RESIDUES {
        //container = params.containers.renumber_residues
        executor = 'local'
    }

    withName: FILTER_DESIGNS {
        executor = 'local'
    }

    withName: COMBINE_SCORES {
        //container = params.containers.combine_scores
        executor = 'local'
    }

    withName: RFDIFFUSION {
        //container = params.containers.rfdiffusion

        // GPU partition
        clusterOptions = '--gres=gpu:1 --partition=gpu' + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        // H100-80G
        // clusterOptions = "--gres=gpu:1 --partition=m3h --qos=m3h" + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        // BDI: A100/A40
        //clusterOptions = '--gres=gpu:1 --partition=bdi --qos=bdiq' + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        time = 2.hours
        accelerator = 1

        memory = '64g'
        cpus = 16
    }

    withName: RFDIFFUSION_PARTIAL {
        //container = params.containers.rfdiffusion

        // GPU partition
        clusterOptions = '--gres=gpu:1 --partition=gpu' + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        // H100-80G
        // clusterOptions = "--gres=gpu:1 --partition=m3h --qos=m3h" + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        // BDI: A100/A40
        //clusterOptions = '--gres=gpu:1 --partition=bdi --qos=bdiq' + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        time = 30.minutes
        accelerator = 1
        memory = '64g'
        cpus = 16
    }

    withName: DL_BINDER_DESIGN_PROTEINMPNN {
        //container = params.containers.dl_binder_design_proteinmpnn

        // CPU only
        // clusterOptions = "--partition=genomics --qos=genomics" + (params.slurm_account ? " --account=${params.slurm_account} " : '')
        clusterOptions = '--partition=comp --qos=shortq' + (params.slurm_account ? " --account=${params.slurm_account} " : '')
        time = 30.minutes

        memory = '4g'
        cpus = 1
    }

    withName: AF2_INITIAL_GUESS {
        //container = params.containers.af2_initial_guess
        accelerator = 1

        // GPU partition
        clusterOptions = '--gres=gpu:1 --partition=gpu' + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        // H100-80G
        //clusterOptions = '--gres=gpu:1 --partition=m3h --qos=m3h' + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        // BDI: A100/A40
        //clusterOptions = "--gres=gpu:1 --partition=bdi --qos=bdiq" + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        time = 2.hours

        memory = '64g'
        cpus = 16
    }

    withName: CREATE_BOLTZ_YAML {
        executor = 'local'
    }

    withName: PARSE_BOLTZ_CONFIDENCE_JSON {
        executor = 'local'
    }

    withName: MMSEQS_COLABFOLDSEARCH {
        // comp partition
        clusterOptions = '--partition=comp' + (params.slurm_account ? " --account=${params.slurm_account} " : '')
        time = 4.hours
        memory = '64g'
        cpus = 16

    // genomics partition
    //clusterOptions = "--partition=genomics --qos=genomics" + (params.slurm_account ? " --account=${params.slurm_account} " : "")
    //time = 4.hours
    //memory = '128g' // '360g'
    //cpus = 24       // 48
    // Load index into RAM
    //ext.args = "--db-load-mode 2"
    }

    withName: BOLTZ {
        accelerator = 1

        // GPU partition
        clusterOptions = '--gres=gpu:1 --partition=gpu' + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        // BDI: A100/A40
        //clusterOptions = "--gres=gpu:1 --partition=bdi --qos=bdiq" + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        time = 1.hours
        memory = '64g'
        cpus = 2
    }

    withName: BINDCRAFT_CREATE_SETTINGS {
        executor = 'local'
    }

    withName: BINDCRAFT {
        accelerator = 1
        time = 2.hours
        memory = '32g'
        cpus = 16

        // GPU partition
        clusterOptions = '--gres=gpu:1 --partition=gpu' + (params.slurm_account ? " --account=${params.slurm_account} " : '')

        // BDI: A100/A40
        // clusterOptions = "--gres=gpu:1 --partition=bdi --qos=bdiq" + (params.slurm_account ? " --account=${params.slurm_account} " : '')
    }
}

// Apptainer specific settings
apptainer {
    enabled = true
    autoMounts = true
    pullTimeout = 3.hours

    // --nv to enable NVIDIA GPU support    
    runOptions = "--nv --cleanenv -B ${HOME} -B /scratch2 -B /fs04"
    // runOptions = "--nv -B /scratch2 -B /fs04 -B /mnt/reference2/alphafold/alphafold_20240229:/app/dl_binder_design/af2_initial_guess/model_weights"
    // -B ${params.models_basepath}:/models
    envWhitelist = ['BOLTZ_CACHE']
}
